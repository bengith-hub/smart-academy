<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Qualiopi - Smart Academy</title>
    
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --qualiopi: #0066cc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Badge Qualiopi */
        .qualiopi-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--qualiopi);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.8em;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* Test Panel */
        .test-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            z-index: 999;
            max-width: 300px;
            border: 2px solid var(--warning);
        }

        .test-panel h4 {
            color: var(--warning);
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .test-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .test-controls select,
        .test-controls button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85em;
        }

        .test-controls button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
        }

        .test-controls button:hover {
            background: var(--secondary);
        }

        /* Header de formation */
        .formation-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .formation-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.1);
            opacity: 0.1;
        }

        .formation-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .formation-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .apprenant-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
        }

        .formation-metadata {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Container principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Informations Qualiopi */
        .qualiopi-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 2px solid var(--qualiopi);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .qualiopi-info h3 {
            color: var(--qualiopi);
            margin-bottom: 15px;
        }

        .qualiopi-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .qualiopi-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .qualiopi-item strong {
            color: var(--qualiopi);
            display: block;
            margin-bottom: 5px;
        }

        /* Navigation des modules */
        .modules-nav {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            overflow-x: auto;
            align-items: center;
        }

        .module-nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
            justify-content: center;
            border: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .module-nav-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .module-nav-item.completed {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .module-nav-item:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--primary);
        }

        .module-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        /* Contenu de formation */
        .formation-content {
            background: white;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .module-content {
            display: none;
            min-height: 600px;
        }

        .module-content.active {
            display: block;
        }

        .module-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-bottom: 1px solid #e9ecef;
        }

        .module-title {
            color: var(--primary);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .module-description {
            color: #666;
            font-size: 1.1em;
        }

        .module-objectives {
            background: #f8f9fa;
            border-left: 4px solid var(--info);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .module-objectives h4 {
            color: var(--info);
            margin-bottom: 10px;
        }

        .module-objectives ul {
            list-style-type: none;
            padding: 0;
        }

        .module-objectives li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .module-objectives li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        .canva-container {
            position: relative;
            padding: 30px;
            text-align: center;
        }

        .canva-embed {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Tracking de temps */
        .time-tracker {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-tracker-info {
            display: flex;
            gap: 20px;
        }

        .time-item {
            text-align: center;
        }

        .time-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #856404;
        }

        .time-label {
            font-size: 0.8em;
            color: #856404;
        }

        .module-progress {
            background: #f8f9fa;
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 12px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #666;
        }

        /* Quiz section */
        .quiz-section {
            background: linear-gradient(135deg, #fff5f5, #ffe0e0);
            margin: 20px 0;
            border-radius: 15px;
            padding: 30px;
            border: 2px solid #ffc107;
        }

        .quiz-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .quiz-title {
            color: var(--warning);
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .quiz-criteria {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--info);
        }

        .quiz-criteria h4 {
            color: var(--info);
            margin-bottom: 15px;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .criteria-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .criteria-score {
            font-weight: bold;
            color: var(--primary);
        }

        .question-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .question-title {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .question-competence {
            background: #e3f2fd;
            color: var(--info);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-bottom: 15px;
            display: inline-block;
        }

        .question-options {
            display: grid;
            gap: 12px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .option.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        /* Boutons de navigation */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: #333;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Tableau de bord */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .dashboard-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .dashboard-label {
            color: #666;
            margin-top: 5px;
        }

        /* Suivi d'assiduité */
        .assiduite-tracker {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--success);
        }

        .assiduite-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .assiduite-title {
            color: var(--success);
            font-size: 1.2em;
            font-weight: 600;
        }

        .assiduite-status {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .assiduite-status.active {
            background: #d4edda;
            color: #155724;
        }

        .assiduite-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .assiduite-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .assiduite-value {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--success);
        }

        .assiduite-label {
            font-size: 0.8em;
            color: #666;
        }

        /* Messages de validation */
        .completion-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid var(--success);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }

        .completion-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .qualiopi-certification {
            background: var(--qualiopi);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        /* Loading et états */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #f5c6cb;
            margin: 20px;
        }

        /* Timer */
        .timer {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-weight: 500;
        }

        /* Messages d'avertissement */
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }

        .warning-box h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .url-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            margin: 10px 0;
            word-break: break-all;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .formation-title {
                font-size: 2em;
            }
            
            .apprenant-info,
            .formation-metadata {
                position: relative;
                top: auto;
                left: auto;
                margin-top: 15px;
                display: block;
                text-align: center;
            }

            .test-panel {
                position: relative;
                top: auto;
                right: auto;
                margin: 20px;
                max-width: none;
            }

            .timer {
                position: relative;
                top: auto;
                left: auto;
                margin: 10px 20px;
                display: inline-block;
            }
            
            .modules-nav {
                flex-direction: column;
                align-items: stretch;
            }
            
            .module-nav-item {
                min-width: auto;
            }
            
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }

            .qualiopi-details {
                grid-template-columns: 1fr;
            }

            .criteria-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script src="js/config.js"></script>
</head>
<body>
    <!-- Badge Qualiopi -->
    <div class="qualiopi-badge">
        ✓ QUALIOPI CERTIFIÉ
    </div>

    <!-- Panel de test -->
    <div class="test-panel" id="test-panel">
        <h4>🧪 Mode Test</h4>
        <div class="test-controls">
            <select id="formation-select">
                <option value="">Chargement des formations...</option>
            </select>
            
            <select id="client-select">
                <option value="">Sélectionner un client</option>
                <option value="CLIENT_001">Entreprise ABC</option>
                <option value="CLIENT_002">Société XYZ</option>
                <option value="CLIENT_003">Organisation DEF</option>
            </select>
            
            <select id="apprenant-select">
                <option value="">Mode anonyme</option>
                <option value="APP_001">Jean Dupont</option>
                <option value="APP_002">Marie Martin</option>
                <option value="APP_003">Pierre Durand</option>
                <option value="PREVIEW">Mode Prévisualisation</option>
            </select>
            
            <button onclick="startTestFormation()">▶️ Lancer le test</button>
            <button onclick="resetToHome()" style="background: #6c757d;">🏠 Accueil</button>
            <button onclick="toggleTestPanel()">❌ Masquer</button>
        </div>
    </div>

    <!-- Timer de session -->
    <div class="timer" id="session-timer">
        ⏱️ <span id="timer-display">00:00</span>
    </div>

    <!-- Header de la formation -->
    <div class="formation-header">
        <div class="apprenant-info" id="apprenant-info">
            🆔 Chargement...
        </div>
        <h1 class="formation-title" id="formation-title">Chargement de la formation...</h1>
        <p class="formation-subtitle" id="formation-subtitle">Veuillez patienter</p>
        <div class="formation-metadata" id="formation-metadata">
            <span id="formation-duration">Durée: -</span>
            <span id="formation-domain">Domaine: -</span>
            <span id="formation-level">Niveau: -</span>
        </div>
    </div>

    <div class="container">
        <!-- Message d'avertissement pour les paramètres manquants -->
        <div class="warning-box" id="params-warning" style="display: none;">
            <h3>⚠️ Paramètres manquants dans l'URL</h3>
            <p>Cette page nécessite des paramètres pour fonctionner correctement.</p>
            <p><strong>Format attendu :</strong></p>
            <div class="url-example">
                votre-url?formationId=FORM_001&apprenantId=APP_001&clientId=CLIENT_001
            </div>
            <p>Ou utilisez le panel de test ci-dessus pour tester différentes configurations.</p>
        </div>

        <!-- Informations Qualiopi -->
        <div class="qualiopi-info" id="qualiopi-info" style="display: none;">
            <h3>📋 Informations de la formation (Qualiopi)</h3>
            <p>Formation certifiée conforme aux exigences du référentiel national qualité</p>
            <div class="qualiopi-details">
                <div class="qualiopi-item">
                    <strong>Organisme</strong>
                    <span id="organisme-nom">Smart Academy</span>
                </div>
                <div class="qualiopi-item">
                    <strong>N° Déclaration</strong>
                    <span id="organisme-numero">11 75 54321 75</span>
                </div>
                <div class="qualiopi-item">
                    <strong>Certification</strong>
                    <span>Qualiopi RNQ</span>
                </div>
                <div class="qualiopi-item">
                    <strong>Client</strong>
                    <span id="client-nom">-</span>
                </div>
                <div class="qualiopi-item">
                    <strong>Référence</strong>
                    <span id="formation-reference">-</span>
                </div>
                <div class="qualiopi-item">
                    <strong>Version</strong>
                    <span id="formation-version">1.0</span>
                </div>
            </div>
        </div>

        <!-- Suivi d'assiduité -->
        <div class="assiduite-tracker" id="assiduite-tracker" style="display: none;">
            <div class="assiduite-header">
                <h3 class="assiduite-title">📊 Suivi d'assiduité</h3>
                <div class="assiduite-status active">
                    ● En formation
                </div>
            </div>
            <div class="assiduite-details">
                <div class="assiduite-item">
                    <div class="assiduite-value" id="session-start">-</div>
                    <div class="assiduite-label">Début session</div>
                </div>
                <div class="assiduite-item">
                    <div class="assiduite-value" id="time-active">00:00</div>
                    <div class="assiduite-label">Temps actif</div>
                </div>
                <div class="assiduite-item">
                    <div class="assiduite-value" id="modules-visited">0</div>
                    <div class="assiduite-label">Modules consultés</div>
                </div>
                <div class="assiduite-item">
                    <div class="assiduite-value" id="interactions-count">0</div>
                    <div class="assiduite-label">Interactions</div>
                </div>
                <div class="assiduite-item">
                    <div class="assiduite-value" id="presence-rate">100%</div>
                    <div class="assiduite-label">Taux présence</div>
                </div>
            </div>
        </div>

        <!-- Tableau de bord de progression -->
        <div class="dashboard" id="dashboard" style="display: none;">
            <div class="dashboard-card">
                <div class="dashboard-number" id="progress-percent">0%</div>
                <div class="dashboard-label">Progression</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-number" id="modules-completed">0/0</div>
                <div class="dashboard-label">Modules terminés</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-number" id="quiz-score">-</div>
                <div class="dashboard-label">Score global</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-number" id="time-spent">0min</div>
                <div class="dashboard-label">Temps passé</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-number" id="competences-validees">0</div>
                <div class="dashboard-label">Compétences validées</div>
            </div>
        </div>

        <!-- Navigation des modules -->
        <div class="modules-nav" id="modules-nav" style="display: none;">
            <!-- Modules générés dynamiquement -->
        </div>

        <!-- Contenu de formation -->
        <div class="formation-content" id="formation-content" style="display: none;">
            <!-- Modules de contenu générés dynamiquement -->
        </div>

        <!-- Message de completion -->
        <div class="completion-message" id="completion-message" style="display: none;">
            <div class="completion-icon">🎓</div>
            <h2>Félicitations !</h2>
            <p>Vous avez terminé la formation avec succès.</p>
            
            <div class="qualiopi-certification">
                <h4>📜 Certification Qualiopi</h4>
                <p>Cette formation répond aux critères de qualité du référentiel national</p>
                <div style="margin: 15px 0;">
                    <strong>Score final:</strong> <span id="final-score">-</span>% | 
                    <strong>Durée totale:</strong> <span id="final-duration">-</span>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="downloadCertificate()">
                    📜 Télécharger l'attestation
                </button>
                <button class="btn btn-info" onclick="downloadAssiduityReport()">
                    📊 Rapport d'assiduité
                </button>
                <button class="btn btn-primary" onclick="sendCompletionNotification()">
                    📧 Notifier l'employeur
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Chargement de votre formation personnalisée...</p>
        </div>

        <!-- Message d'erreur -->
        <div class="error-message" id="error-message" style="display: none;">
            <h3>⚠️ Erreur de chargement</h3>
            <p id="error-text">Impossible de charger la formation</p>
            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 15px;">
                🔄 Réessayer
            </button>
        </div>
    </div>

    <script>
        // IMPORTANT: Remplacez cette URL par votre URL de déploiement Google Apps Script
        let API_URL;
        document.addEventListener('DOMContentLoaded', function() {
            Config.init(); // Initialiser Config AVANT tout
            API_URL = Config.current.apiUrl || Config.DEFAULT_API_URL; // PUIS assigner l'URL
    
            console.log('🚀 Smart Academy - Démarrage...');
            initializeFormation();
            startSessionTimer();
            startAssiduiteTacking();
            loadFormationsForTest();
            setupActivityTracking();
        });
        
        // État global de la formation - AMÉLIORÉ POUR QUALIOPI
        let formationState = {
            formationId: null,
            apprenantId: null,
            clientId: null, // NOUVEAU: Gestion multi-clients
            isPreview: false,
            formation: null,
            currentModule: 0,
            isTestMode: false,
            // Progression améliorée pour traçabilité Qualiopi
            progress: {
                modulesCompleted: [],
                quizAnswers: {},
                quizScores: {},
                competencesValidees: [],
                totalTimeSpent: 0,
                startTime: Date.now(),
                sessions: [], // NOUVEAU: Historique des sessions
                interactions: [], // NOUVEAU: Traçabilité des interactions
                evaluations: {} // NOUVEAU: Détail des évaluations
            },
            // NOUVEAU: Métriques d'assiduité
            assiduite: {
                connexionStart: Date.now(),
                tempsActif: 0,
                modulesVisites: new Set(),
                interactions: 0,
                pauseStart: null,
                isActive: true
            }
        };

        // Timer de session
        let sessionTimer = null;
        let assiduiteTimer = null;

        // NOUVEAU: Détection d'activité pour assiduité
        let lastActivity = Date.now();
        let inactivityThreshold = 5 * 60 * 1000; // 5 minutes

        // NOUVEAU: Suivi d'activité pour Qualiopi
        function setupActivityTracking() {
            // Événements qui indiquent une activité
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    updateActivity();
                }, true);
            });

            // Vérification périodique d'inactivité
            setInterval(checkInactivity, 30000); // Chaque 30 secondes
        }

        function updateActivity() {
            lastActivity = Date.now();
            
            if (!formationState.assiduite.isActive) {
                formationState.assiduite.isActive = true;
                logInteraction('retour_activite', 'Reprise d\'activité détectée');
                updateAssiduiteDashboard();
            }
            
            formationState.assiduite.interactions++;
        }

        function checkInactivity() {
            const now = Date.now();
            const timeSinceLastActivity = now - lastActivity;
            
            if (timeSinceLastActivity > inactivityThreshold && formationState.assiduite.isActive) {
                formationState.assiduite.isActive = false;
                formationState.assiduite.pauseStart = now;
                logInteraction('pause_detectee', `Inactivité détectée après ${Math.round(timeSinceLastActivity/1000)}s`);
                updateAssiduiteDashboard();
            }
        }

        // NOUVEAU: Suivi d'assiduité
        function startAssiduiteTacking() {
            assiduiteTimer = setInterval(() => {
                if (formationState.assiduite.isActive) {
                    formationState.assiduite.tempsActif += 1000; // +1 seconde
                }
                updateAssiduiteDashboard();
            }, 1000);
        }

        function updateAssiduiteDashboard() {
            if (!formationState.apprenantId) return;
            
            const startTime = new Date(formationState.assiduite.connexionStart);
            document.getElementById('session-start').textContent = startTime.toLocaleTimeString();
            
            const activeMinutes = Math.floor(formationState.assiduite.tempsActif / (1000 * 60));
            const activeSeconds = Math.floor((formationState.assiduite.tempsActif % (1000 * 60)) / 1000);
            document.getElementById('time-active').textContent = 
                `${activeMinutes.toString().padStart(2, '0')}:${activeSeconds.toString().padStart(2, '0')}`;
            
            document.getElementById('modules-visited').textContent = formationState.assiduite.modulesVisites.size;
            document.getElementById('interactions-count').textContent = formationState.assiduite.interactions;
            
            // Calcul du taux de présence
            const totalTime = Date.now() - formationState.assiduite.connexionStart;
            const presenceRate = totalTime > 0 ? Math.round((formationState.assiduite.tempsActif / totalTime) * 100) : 100;
            document.getElementById('presence-rate').textContent = presenceRate + '%';
        }

        // NOUVEAU: Logging des interactions pour traçabilité
        function logInteraction(type, details, moduleIndex = null) {
            const interaction = {
                timestamp: new Date().toISOString(),
                type: type,
                details: details,
                moduleIndex: moduleIndex,
                url: window.location.href,
                userAgent: navigator.userAgent.substring(0, 100) // Limité pour sécurité
            };
            
            formationState.progress.interactions.push(interaction);
            
            // Sauvegarder périodiquement pour traçabilité
            if (formationState.progress.interactions.length % 10 === 0) {
                saveProgress();
            }
            
            console.log('📝 Interaction loggée:', interaction);
        }

        // Charger les formations disponibles pour le test
        async function loadFormationsForTest() {
            try {
                const response = await fetch(`${API_URL}?action=getFormations&timestamp=${Date.now()}`);
                const result = await response.json();
        
                const select = document.getElementById('formation-select');
                select.innerHTML = '<option value="">Choisir une formation</option>';
        
                if (result.success && result.donnees) {
                    result.donnees.forEach(formation => {
                        const option = document.createElement('option');
                        option.value = formation.id;
                        option.textContent = formation.titre;
                        select.appendChild(option);
                    });
                    console.log('✅ Formations chargées dans le menu test');
                }
            } catch (error) {
                console.error('❌ Erreur chargement formations pour test:', error);
            }
        }

        // Gestion du panel de test
        function toggleTestPanel() {
            const panel = document.getElementById('test-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function resetToHome() {
            // Réinitialiser l'état
            formationState = {
                formationId: null,
                apprenantId: null,
                clientId: null,
                isPreview: false,
                formation: null,
                currentModule: 0,
                isTestMode: false,
                progress: {
                    modulesCompleted: [],
                    quizAnswers: {},
                    quizScores: {},
                    competencesValidees: [],
                    totalTimeSpent: 0,
                    startTime: Date.now(),
                    sessions: [],
                    interactions: [],
                    evaluations: {}
                },
                assiduite: {
                    connexionStart: Date.now(),
                    tempsActif: 0,
                    modulesVisites: new Set(),
                    interactions: 0,
                    pauseStart: null,
                    isActive: true
                }
            };

            // Réinitialiser l'interface
            document.getElementById('formation-title').textContent = 'Chargement de la formation...';
            document.getElementById('formation-subtitle').textContent = 'Veuillez patienter';
            document.getElementById('apprenant-info').textContent = '🆔 Chargement...';
            
            // Masquer tous les éléments de formation
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('qualiopi-info').style.display = 'none';
            document.getElementById('assiduite-tracker').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('modules-nav').style.display = 'none';
            document.getElementById('formation-content').style.display = 'none';
            document.getElementById('completion-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // Afficher l'avertissement de paramètres
            document.getElementById('params-warning').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            
            // Réinitialiser les sélecteurs
            document.getElementById('formation-select').value = '';
            document.getElementById('client-select').value = '';
            document.getElementById('apprenant-select').value = '';
            
            // Afficher le panel de test
            document.getElementById('test-panel').style.display = 'block';
            
            console.log('🏠 Retour à l\'accueil');
        }

        function startTestFormation() {
            const formationId = document.getElementById('formation-select').value;
            const clientId = document.getElementById('client-select').value;
            const apprenantId = document.getElementById('apprenant-select').value;
            
            if (!formationId) {
                alert('Veuillez sélectionner une formation');
                return;
            }

            // Mettre à jour l'état
            formationState.formationId = formationId;
            formationState.clientId = clientId;
            formationState.apprenantId = apprenantId === 'PREVIEW' ? null : apprenantId;
            formationState.isPreview = apprenantId === 'PREVIEW';
            formationState.isTestMode = true;

            // Log de début de session
            logInteraction('session_start', `Début formation ${formationId} - Client: ${clientId} - Apprenant: ${apprenantId}`);

            // Masquer le panel de test et l'avertissement
            document.getElementById('test-panel').style.display = 'none';
            document.getElementById('params-warning').style.display = 'none';

            // Relancer l'initialisation
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('error-message').style.display = 'none';
            
            initializeFormation();
        }

        // Analyse des paramètres URL (compatible Google Sites)
        function parseUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Récupérer les paramètres
            formationState.formationId = urlParams.get('formationId');
            formationState.apprenantId = urlParams.get('apprenantId');
            formationState.clientId = urlParams.get('clientId'); // NOUVEAU
            formationState.isPreview = urlParams.get('preview') === 'true';
            
            console.log('Paramètres URL détectés:', {
                formationId: formationState.formationId,
                apprenantId: formationState.apprenantId,
                clientId: formationState.clientId,
                isPreview: formationState.isPreview
            });
        }

        // Initialisation de la formation
        async function initializeFormation() {
            try {
                // Si on n'est pas en mode test, analyser les paramètres URL
                if (!formationState.isTestMode) {
                    parseUrlParameters();
                }
                
                if (!formationState.formationId) {
                    // Afficher l'avertissement et permettre le test
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('params-warning').style.display = 'block';
                    return;
                }
                
                // Charger les données de formation depuis l'API
                await loadFormationData();
                
                // Initialiser l'interface
                setupInterface();
                
                // Charger la progression si apprenant connecté
                if (formationState.apprenantId && !formationState.isPreview) {
                    await loadProgress();
                }
                
                // Afficher la formation
                showFormation();
                
                // Log d'initialisation réussie
                logInteraction('formation_loaded', `Formation ${formationState.formation.titre} chargée avec succès`);
                
            } catch (error) {
                console.error('Erreur initialisation:', error);
                logInteraction('error', `Erreur initialisation: ${error.message}`);
                showError(error.message);
            }
        }

        // Chargement des données de formation avec gestion multi-clients
        async function loadFormationData() {
            try {
                console.log('Chargement formation ID:', formationState.formationId);
        
                const response = await fetch(`${API_URL}?action=obtenirFormations&clientId=${formationState.clientId || ''}&timestamp=${Date.now()}`);
                const result = await response.json();
        
                console.log('Réponse API:', result);
        
                let formation = null;
        
                if (result.success && result.donnees && Array.isArray(result.donnees)) {
                    formation = result.donnees.find(f => 
                        f.id === formationState.formationId ||
                        f.id.toString() === formationState.formationId
                    );
                    
                    console.log('Recherche par ID:', formationState.formationId);
                    console.log('Formations disponibles:', result.donnees.map(f => ({id: f.id, nom: f.titre})));
                }
        
                if (formation) {
                    console.log('✅ Formation trouvée dans l\'API:', formation);
            
                    formationState.formation = {
                        ...formation,
                        // Parsing des modules avec compétences
                        modules: parseModulesFromFormation(formation)
                    };
            
                    console.log('✅ Formation mappée depuis API:', formationState.formation);
                    return;
                } else {
                    console.warn('❌ Formation non trouvée dans l\'API pour ID:', formationState.formationId);
                }
                        
                throw new Error(`Formation "${formationState.formationId}" non trouvée dans l'API`);
                
            } catch (error) {
                console.error('❌ Erreur chargement formation:', error);
                throw new Error(`Impossible de charger la formation: ${error.message}`);
            }
        }

        // Parser les modules avec compétences pour Qualiopi
        function parseModulesFromFormation(formation) {
            try {
                // Générer des modules par défaut basés sur la formation
                const defaultModules = generateDefaultModules(formation.titre, formation.domaine);
                
                // Si on a des URLs Canva, les utiliser
                if (formation.canvaUrls) {
                    const urls = formation.canvaUrls.split(',').map(url => url.trim());
                    defaultModules.forEach((module, index) => {
                        if (urls[index]) {
                            let embedUrl = urls[index];
                            if (!embedUrl.includes('view?embed')) {
                                if (embedUrl.includes('/view?')) {
                                    embedUrl = embedUrl.replace('/view?', '/view?embed&');
                                } else if (embedUrl.includes('/view')) {
                                    embedUrl = embedUrl.replace('/view', '/view?embed');
                                } else {
                                    embedUrl = embedUrl + (embedUrl.includes('?') ? '&embed' : '?embed');
                                }
                            }
                            module.canvaUrl = embedUrl;
                        }
                    });
                }
                
                return defaultModules;
                
            } catch (error) {
                console.error('Erreur parsing modules:', error);
                return generateDefaultModules('Formation', 'Générique');
            }
        }

        // Configuration de l'interface avec informations Qualiopi
        function setupInterface() {
            const formation = formationState.formation;
            
            // Header
            document.getElementById('formation-title').textContent = formation.titre;
            document.getElementById('formation-subtitle').textContent = formation.objectifs || formation.description;
            
            // Métadonnées formation
            document.getElementById('formation-duration').textContent = `Durée: ${formation.dureeHeures || formation.duree}h`;
            document.getElementById('formation-domain').textContent = `Domaine: ${formation.domaine}`;
            document.getElementById('formation-level').textContent = `Niveau: ${formation.niveau || 'Intermédiaire'}`;
            
            // Info apprenant
            const apprenantInfo = document.getElementById('apprenant-info');
            if (formationState.isPreview) {
                apprenantInfo.textContent = '👁️ Mode Prévisualisation';
                apprenantInfo.style.background = 'rgba(255, 193, 7, 0.3)';
            } else if (formationState.apprenantId) {
                apprenantInfo.textContent = `🆔 ${formationState.apprenantId}`;
            } else if (formationState.isTestMode) {
                apprenantInfo.textContent = '🧪 Mode Test';
                apprenantInfo.style.background = 'rgba(23, 162, 184, 0.3)';
            } else {
                apprenantInfo.textContent = '👤 Accès public';
            }
            
            // Informations Qualiopi
            setupQualiopiInfo();
            
            // Navigation des modules
            setupModulesNavigation();
            
            // Contenu des modules
            setupModulesContent();
            
            // Dashboard
            updateDashboard();
        }

        // NOUVEAU: Configuration des informations Qualiopi
        function setupQualiopiInfo() {
            const formation = formationState.formation;
            
            // Remplir les informations Qualiopi
            document.getElementById('formation-reference').textContent = formation.reference || formation.id;
            document.getElementById('formation-version').textContent = formation.version || '1.0';
            
            // Information client si disponible
            if (formationState.clientId) {
                const clientNames = {
                    'CLIENT_001': 'Entreprise ABC',
                    'CLIENT_002': 'Société XYZ',
                    'CLIENT_003': 'Organisation DEF'
                };
                document.getElementById('client-nom').textContent = clientNames[formationState.clientId] || formationState.clientId;
            }
            
            document.getElementById('qualiopi-info').style.display = 'block';
            
            if (formationState.apprenantId && !formationState.isPreview) {
                document.getElementById('assiduite-tracker').style.display = 'block';
            }
        }

        // Configuration de la navigation des modules
        function setupModulesNavigation() {
            const nav = document.getElementById('modules-nav');
            const formation = formationState.formation;
            
            nav.innerHTML = formation.modules.map((module, index) => `
                <div class="module-nav-item ${index === 0 ? 'active' : ''}" 
                     onclick="navigateToModule(${index})" 
                     id="nav-module-${index}">
                    <div class="module-status" id="status-module-${index}">
                        ${index + 1}
                    </div>
                    <span>${module.titre}</span>
                </div>
            `).join('');
        }

        // Configuration du contenu des modules avec compétences
        function setupModulesContent() {
            const content = document.getElementById('formation-content');
            const formation = formationState.formation;
            
            content.innerHTML = formation.modules.map((module, index) => `
                <div class="module-content ${index === 0 ? 'active' : ''}" id="module-${index}">
                    <div class="module-header">
                        <h2 class="module-title">${module.titre}</h2>
                        <p class="module-description">${module.description}</p>
                        
                        <!-- NOUVEAU: Objectifs pédagogiques -->
                        <div class="module-objectives">
                            <h4>🎯 Objectifs pédagogiques</h4>
                            <ul>
                                ${(module.objectifsPedagogiques || []).map(obj => `<li>${obj}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <!-- NOUVEAU: Compétences visées -->
                        <div class="module-objectives" style="border-left-color: var(--success);">
                            <h4 style="color: var(--success);">⭐ Compétences visées</h4>
                            <ul>
                                ${(module.competences || []).map(comp => `<li>${comp}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="canva-container">
                        <iframe class="canva-embed" 
                                src="${module.canvaUrl}" 
                                allowfullscreen>
                        </iframe>
                        <p style="margin-top: 15px; color: #666;">
                            📚 Consultez attentivement tous les éléments de ce module
                        </p>
                    </div>
                    
                    <!-- NOUVEAU: Tracker de temps sur le module -->
                    <div class="time-tracker">
                        <div class="time-tracker-info">
                            <div class="time-item">
                                <div class="time-value" id="module-time-${index}">00:00</div>
                                <div class="time-label">Temps sur module</div>
                            </div>
                            <div class="time-item">
                                <div class="time-value" id="module-interactions-${index}">0</div>
                                <div class="time-label">Interactions</div>
                            </div>
                        </div>
                        <button class="btn btn-warning" onclick="markModuleAsStudied(${index})">
                            📖 Marquer comme étudié
                        </button>
                    </div>
                    
                    <div class="module-progress">
                        <div class="progress-text">
                            <span>Progression du module</span>
                            <span id="module-progress-${index}">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill-${index}" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    ${generateQuizHtml(module.quiz, index)}
                    
                    <div class="navigation-buttons">
                        <button class="btn btn-secondary" 
                                onclick="navigateToModule(${index - 1})" 
                                ${index === 0 ? 'disabled' : ''}>
                            ← Module précédent
                        </button>
                        
                        <div id="module-actions-${index}">
                            <button class="btn btn-primary" onclick="startModuleProgress(${index})">
                                ▶️ Commencer le module
                            </button>
                        </div>
                        
                        <button class="btn btn-secondary" 
                                onclick="navigateToModule(${index + 1})" 
                                ${index === formation.modules.length - 1 ? 'disabled' : ''} 
                                id="next-btn-${index}" 
                                style="${!formationState.progress.modulesCompleted.includes(index) ? 'opacity: 0.5; pointer-events: none;' : ''}">
                            Module suivant →
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Affichage de la formation
        function showFormation() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';
            document.getElementById('modules-nav').style.display = 'flex';
            document.getElementById('formation-content').style.display = 'block';
        }

        // Timer de session
        function startSessionTimer() {
            let seconds = 0;
            sessionTimer = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                document.getElementById('timer-display').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Fonctions de formation simplifiées pour le test
        function navigateToModule(moduleIndex) {
            const formation = formationState.formation;
            
            if (moduleIndex < 0 || moduleIndex >= formation.modules.length) {
                return;
            }
            
            logInteraction('module_navigation', `Navigation vers module ${moduleIndex + 1}`, moduleIndex);
            
            document.querySelectorAll('.module-content').forEach(module => {
                module.classList.remove('active');
            });
            document.querySelectorAll('.module-nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            document.getElementById(`module-${moduleIndex}`).classList.add('active');
            document.getElementById(`nav-module-${moduleIndex}`).classList.add('active');
            
            formationState.currentModule = moduleIndex;
            formationState.assiduite.modulesVisites.add(moduleIndex);
            
            updateDashboard();
        }

        function startModuleProgress(moduleIndex) {
            const module = formationState.formation.modules[moduleIndex];
            const moduleActions = document.getElementById(`module-actions-${moduleIndex}`);
            
            logInteraction('module_start', `Début du module "${module.titre}"`, moduleIndex);
            formationState.assiduite.modulesVisites.add(moduleIndex);
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                updateModuleProgress(moduleIndex, progress);
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    completeModule(moduleIndex);
                }
            }, 200);
            
            moduleActions.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span>📖 Module en cours...</span>
                    <button class="btn btn-success" onclick="forceCompleteModule(${moduleIndex})">
                        ✅ Marquer comme terminé
                    </button>
                </div>
            `;
        }

        function updateModuleProgress(moduleIndex, progress) {
            document.getElementById(`module-progress-${moduleIndex}`).textContent = `${Math.round(progress)}%`;
            document.getElementById(`progress-fill-${moduleIndex}`).style.width = `${progress}%`;
        }

        function completeModule(moduleIndex) {
            const module = formationState.formation.modules[moduleIndex];
            const moduleActions = document.getElementById(`module-actions-${moduleIndex}`);
            const navStatus = document.getElementById(`status-module-${moduleIndex}`);
            const navItem = document.getElementById(`nav-module-${moduleIndex}`);
            
            logInteraction('module_completed', `Module "${module.titre}" terminé`, moduleIndex);
            
            if (!formationState.progress.modulesCompleted.includes(moduleIndex)) {
                formationState.progress.modulesCompleted.push(moduleIndex);
            }
            
            navStatus.textContent = '✅';
            navItem.classList.add('completed');
            navItem.classList.remove('active');
            
            const nextBtn = document.getElementById(`next-btn-${moduleIndex}`);
            if (nextBtn) {
                nextBtn.style.opacity = '1';
                nextBtn.style.pointerEvents = 'auto';
            }
            
            const quizElement = document.getElementById(`quiz-${moduleIndex}`);
            if (quizElement) {
                quizElement.style.display = 'block';
            }
            
            moduleActions.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: var(--success);">✅ Module terminé</span>
                    <button class="btn btn-primary" onclick="scrollToQuiz(${moduleIndex})">
                        🧠 Passer à l'évaluation
                    </button>
                </div>
            `;
            
            updateDashboard();
            saveProgress();
            checkFormationCompletion();
        }

        function forceCompleteModule(moduleIndex) {
            updateModuleProgress(moduleIndex, 100);
            completeModule(moduleIndex);
        }

        function markModuleAsStudied(moduleIndex) {
            const module = formationState.formation.modules[moduleIndex];
            
            logInteraction('module_studied', `Module "${module.titre}" marqué comme étudié`, moduleIndex);
            
            const interactionsElement = document.getElementById(`module-interactions-${moduleIndex}`);
            if (interactionsElement) {
                const current = parseInt(interactionsElement.textContent) || 0;
                interactionsElement.textContent = current + 1;
            }
            
            if (module.competences) {
                module.competences.forEach(competence => {
                    if (!formationState.progress.competencesValidees.includes(competence)) {
                        formationState.progress.competencesValidees.push(competence);
                    }
                });
                updateDashboard();
            }
            
            alert(`✅ Module "${module.titre}" marqué comme étudié.\n\nCompétences étudiées:\n${(module.competences || []).join('\n')}`);
        }

        function scrollToQuiz(moduleIndex) {
            const quizElement = document.getElementById(`quiz-${moduleIndex}`);
            if (quizElement) {
                quizElement.scrollIntoView({ behavior: 'smooth' });
            }
            logInteraction('quiz_access', `Accès au quiz du module ${moduleIndex + 1}`, moduleIndex);
        }

        // Génération du HTML des quiz
        function generateQuizHtml(quiz, moduleIndex) {
            if (!quiz || !quiz.questions || quiz.questions.length === 0) {
                return '';
            }
            
            const module = formationState.formation.modules[moduleIndex];
            
            return `
                <div class="quiz-section" id="quiz-${moduleIndex}" style="display: none;">
                    <div class="quiz-header">
                        <h3 class="quiz-title">🧠 Évaluation des acquis</h3>
                        <p>Validation des compétences du module</p>
                    </div>
                    
                    <div class="quiz-criteria">
                        <h4>📋 Critères d'évaluation</h4>
                        <div class="criteria-grid">
                            <div class="criteria-item">
                                <div class="criteria-score">≥ 70%</div>
                                <div>Score minimum requis</div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-score">${quiz.questions.length}</div>
                                <div>Questions à traiter</div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-score">${module.competences ? module.competences.length : 0}</div>
                                <div>Compétences évaluées</div>
                            </div>
                        </div>
                        
                        ${module.competences && module.competences.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <strong>Compétences évaluées dans ce quiz:</strong>
                                <ul style="margin: 10px 0; padding-left: 20px;">
                                    ${module.competences.map(comp => `<li>${comp}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${quiz.questions.map((question, qIndex) => `
                        <div class="question-container">
                            ${question.competence ? `
                                <div class="question-competence">
                                    📌 Compétence: ${question.competence}
                                </div>
                            ` : ''}
                            
                            <div class="question-title">
                                Question ${qIndex + 1}: ${question.question}
                            </div>
                            
                            <div class="question-options">
                                ${question.options.map((option, oIndex) => `
                                    <label class="option" onclick="selectAnswer(${moduleIndex}, ${qIndex}, ${oIndex})">
                                        <input type="radio" name="question_${moduleIndex}_${qIndex}" value="${oIndex}">
                                        ${option}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn btn-success" onclick="submitQuiz(${moduleIndex})">
                            ✅ Valider l'évaluation
                        </button>
                    </div>
                </div>
            `;
        }

        function selectAnswer(moduleIndex, questionIndex, optionIndex) {
            if (!formationState.progress.quizAnswers[moduleIndex]) {
                formationState.progress.quizAnswers[moduleIndex] = {};
            }
            formationState.progress.quizAnswers[moduleIndex][questionIndex] = optionIndex;
            
            logInteraction('quiz_answer_selected', 
                `Réponse ${optionIndex + 1} sélectionnée pour question ${questionIndex + 1}`, 
                moduleIndex);
            
            document.querySelectorAll(`input[name="question_${moduleIndex}_${questionIndex}"]`).forEach(input => {
                input.closest('.option').classList.remove('selected');
            });
            document.querySelector(`input[name="question_${moduleIndex}_${questionIndex}"][value="${optionIndex}"]`)
                .closest('.option').classList.add('selected');
        }

        function submitQuiz(moduleIndex) {
            const module = formationState.formation.modules[moduleIndex];
            const answers = formationState.progress.quizAnswers[moduleIndex] || {};
            
            for (let i = 0; i < module.quiz.questions.length; i++) {
                if (answers[i] === undefined) {
                    alert(`Veuillez répondre à la question ${i + 1}`);
                    return;
                }
            }
            
            let correctAnswers = 0;
            module.quiz.questions.forEach((question, index) => {
                if (answers[index] === question.correct) {
                    correctAnswers++;
                }
            });
            
            const score = Math.round((correctAnswers / module.quiz.questions.length) * 100);
            const passed = score >= 70;
            
            formationState.progress.evaluations[moduleIndex] = {
                score: score,
                passed: passed,
                timestamp: new Date().toISOString(),
                competencesValidees: passed ? (module.competences || []) : []
            };
            
            logInteraction('quiz_submitted', 
                `Quiz soumis - Score: ${score}% - ${passed ? 'Réussi' : 'Échec'}`, 
                moduleIndex);
            
            if (passed && module.competences) {
                module.competences.forEach(competence => {
                    if (!formationState.progress.competencesValidees.includes(competence)) {
                        formationState.progress.competencesValidees.push(competence);
                    }
                });
            }
            
            showQuizResult(moduleIndex, score, passed, correctAnswers, module.quiz.questions.length);
            
            if (!formationState.progress.quizScores) {
                formationState.progress.quizScores = {};
            }
            formationState.progress.quizScores[moduleIndex] = score;
            
            updateDashboard();
            saveProgress();
        }

        function showQuizResult(moduleIndex, score, passed, correct, total) {
            const quizSection = document.getElementById(`quiz-${moduleIndex}`);
            
            const resultHtml = `
                <div style="background: ${passed ? '#d4edda' : '#f8d7da'}; 
                            border: 2px solid ${passed ? '#28a745' : '#dc3545'}; 
                            border-radius: 10px; 
                            padding: 20px; 
                            text-align: center; 
                            margin: 20px 0;">
                    <h4 style="color: ${passed ? '#155724' : '#721c24'};">
                        ${passed ? '✅ Évaluation réussie !' : '❌ Évaluation non réussie'}
                    </h4>
                    <p style="font-size: 1.2em; margin: 10px 0;">
                        Score: ${score}% (${correct}/${total} bonnes réponses)
                    </p>
                    <p style="color: #666;">
                        ${passed ? 
                            'Félicitations ! Vous maîtrisez les compétences de ce module.' : 
                            'Score minimum requis: 70%. Vous pouvez recommencer le quiz.'
                        }
                    </p>
                    
                    <div style="margin-top: 15px;">
                        ${passed ? 
                            `<button class="btn btn-success" onclick="navigateToModule(${moduleIndex + 1})">
                                Module suivant →
                            </button>` :
                            `<button class="btn btn-warning" onclick="retryQuiz(${moduleIndex})">
                                🔄 Recommencer l'évaluation
                            </button>`
                        }
                    </div>
                </div>
            `;
            
            const submitButton = quizSection.querySelector('button[onclick*="submitQuiz"]');
            if (submitButton) {
                submitButton.parentElement.innerHTML = resultHtml;
            }
        }

        function retryQuiz(moduleIndex) {
            if (formationState.progress.quizAnswers[moduleIndex]) {
                delete formationState.progress.quizAnswers[moduleIndex];
            }
            
            logInteraction('quiz_retry', `Recommencer quiz module ${moduleIndex + 1}`, moduleIndex);
            
            location.reload(); // Rechargement simple pour reset
        }

        function updateDashboard() {
            const formation = formationState.formation;
            const progress = formationState.progress;
            
            const progressPercent = Math.round((progress.modulesCompleted.length / formation.modules.length) * 100);
            document.getElementById('progress-percent').textContent = `${progressPercent}%`;
            
            document.getElementById('modules-completed').textContent = 
                `${progress.modulesCompleted.length}/${formation.modules.length}`;
            
            let averageScore = '-';
            if (progress.quizScores && Object.keys(progress.quizScores).length > 0) {
                const scores = Object.values(progress.quizScores);
                averageScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) + '%';
            }
            document.getElementById('quiz-score').textContent = averageScore;
            
            const timeSpent = Math.round((Date.now() - progress.startTime) / (1000 * 60));
            document.getElementById('time-spent').textContent = `${timeSpent}min`;
            
            document.getElementById('competences-validees').textContent = progress.competencesValidees.length;
        }

        function checkFormationCompletion() {
            const formation = formationState.formation;
            const progress = formationState.progress;
            
            const allModulesCompleted = progress.modulesCompleted.length === formation.modules.length;
            
            let allQuizPassed = true;
            if (progress.quizScores) {
                Object.values(progress.quizScores).forEach(score => {
                    if (score < 70) {
                        allQuizPassed = false;
                    }
                });
            } else {
                allQuizPassed = false;
            }
            
            if (allModulesCompleted && allQuizPassed) {
                showFormationCompletion();
            }
        }

        function showFormationCompletion() {
            const finalScore = calculateGlobalScore();
            const finalDuration = Math.round((Date.now() - formationState.progress.startTime) / (1000 * 60));
            
            document.getElementById('final-score').textContent = finalScore;
            document.getElementById('final-duration').textContent = `${finalDuration} minutes`;
            
            document.getElementById('formation-content').style.display = 'none';
            document.getElementById('completion-message').style.display = 'block';
            
            logInteraction('formation_completed', 
                `Formation terminée - Score: ${finalScore}% - Durée: ${finalDuration}min`);
        }

        function calculateGlobalScore() {
            const scores = formationState.progress.quizScores;
            if (!scores || Object.keys(scores).length === 0) return 0;
            
            const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
            return Math.round(totalScore / Object.keys(scores).length);
        }

        // Sauvegarde de progression
        async function loadProgress() {
            if (formationState.isTestMode) {
                console.log('Mode test - Progression non chargée depuis l\'API');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}?action=getProgression&apprenantId=${formationState.apprenantId}&formationId=${formationState.formationId}&timestamp=${Date.now()}`);
                const result = await response.json();
                
                if (result && result.progression) {
                    formationState.progress = { 
                        ...formationState.progress, 
                        ...result.progression,
                        competencesValidees: result.progression.competencesValidees || [],
                        interactions: result.progression.interactions || [],
                        evaluations: result.progression.evaluations || {}
                    };
                    
                    console.log('Progression chargée:', formationState.progress);
                }
                
            } catch (error) {
                console.error('Erreur chargement progression:', error);
            }
        }

        async function saveProgress() {
            if (formationState.isPreview || formationState.isTestMode) {
                console.log('Mode prévisualisation/test - Progression non sauvegardée');
                return;
            }
            
            if (!formationState.apprenantId) {
                console.log('Pas d\'ID apprenant - Progression non sauvegardée');
                return;
            }
            
            try {
                const progressData = {
                    action: 'sauvegarderProgression',
                    apprenantId: formationState.apprenantId,
                    formationId: formationState.formationId,
                    clientId: formationState.clientId,
                    progression: {
                        ...formationState.progress,
                        modulesVisites: Array.from(formationState.assiduite.modulesVisites),
                        assiduite: {
                            ...formationState.assiduite,
                            modulesVisites: Array.from(formationState.assiduite.modulesVisites)
                        }
                    },
                    timestamp: new Date().toISOString()
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'data=' + encodeURIComponent(JSON.stringify(progressData))
                });
                
                const result = await response.json();
                console.log('Sauvegarde résultat:', result);
                
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
            }
        }

        // Fonctions pour les attestations et rapports
        function downloadCertificate() {
            if (formationState.isPreview || formationState.isTestMode) {
                alert('📋 Mode test - L\'attestation sera générée pour les vrais apprenants');
                return;
            }
            
            alert('📜 Génération de votre attestation Qualiopi en cours...');
        }

        function downloadAssiduityReport() {
            if (formationState.isPreview || formationState.isTestMode) {
                alert('📋 Mode test - Le rapport d\'assiduité sera généré pour les vrais apprenants');
                return;
            }
            
            alert('📊 Génération du rapport d\'assiduité Qualiopi...');
        }

        function sendCompletionNotification() {
            if (formationState.isPreview || formationState.isTestMode) {
                alert('📋 Mode test - La notification sera envoyée pour les vrais apprenants');
                return;
            }
            
            alert('📧 Notification envoyée avec succès à votre employeur/client !');
        }

        // Génération de modules par défaut
        function generateDefaultModules(titre, domaine) {
            const modulesTemplates = {
                'Cybersécurité': [
                    {
                        id: 'MOD_001',
                        titre: 'Introduction à la cybersécurité',
                        description: 'Découvrez les enjeux et les bases de la cybersécurité en entreprise',
                        objectifsPedagogiques: [
                            'Comprendre les enjeux de la cybersécurité',
                            'Identifier les principales menaces',
                            'Connaître les principes de base de la sécurité'
                        ],
                        competences: [
                            'Maîtriser les concepts fondamentaux de la cybersécurité',
                            'Identifier les principaux risques et menaces numériques'
                        ],
                        canvaUrl: 'https://www.canva.com/design/DAGXM2_7JDU/k3UoDsc6vjNtta0yUvE7qA/view?embed',
                        quiz: {
                            questions: [
                                {
                                    question: 'Qu\'est-ce que la cybersécurité ?',
                                    competence: 'Maîtriser les concepts fondamentaux de la cybersécurité',
                                    options: [
                                        'Protection des systèmes informatiques contre les menaces',
                                        'Création de sites web sécurisés',
                                        'Programmation de logiciels antivirus',
                                        'Gestion exclusive des mots de passe'
                                    ],
                                    correct: 0
                                }
                            ]
                        }
                    },
                    {
                        id: 'MOD_002',
                        titre: 'Gestion des mots de passe',
                        description: 'Apprenez à créer et gérer des mots de passe sécurisés',
                        objectifsPedagogiques: [
                            'Créer des mots de passe robustes',
                            'Utiliser un gestionnaire de mots de passe',
                            'Comprendre l\'authentification multi-facteurs'
                        ],
                        competences: [
                            'Appliquer les bonnes pratiques de gestion des mots de passe',
                            'Utiliser des outils de gestion sécurisée des mots de passe'
                        ],
                        canvaUrl: 'https://www.canva.com/design/DAGXM2_7JDU/k3UoDsc6vjNtta0yUvE7qA/view?embed',
                        quiz: {
                            questions: [
                                {
                                    question: 'Quelle est la longueur minimale recommandée pour un mot de passe en 2024 ?',
                                    competence: 'Appliquer les bonnes pratiques de gestion des mots de passe',
                                    options: ['8 caractères', '10 caractères', '12 caractères', '16 caractères'],
                                    correct: 2
                                }
                            ]
                        }
                    }
                ]
            };

            return modulesTemplates[domaine] || [
                {
                    id: 'MOD_001',
                    titre: `Introduction - ${titre}`,
                    description: 'Module d\'introduction à la formation',
                    objectifsPedagogiques: ['Comprendre les objectifs', 'Acquérir les bases'],
                    competences: ['Compétence fondamentale 1', 'Compétence fondamentale 2'],
                    canvaUrl: 'https://www.canva.com/design/DAGXM2_7JDU/k3UoDsc6vjNtta0yUvE7qA/view?embed',
                    quiz: {
                        questions: [
                            {
                                question: 'Avez-vous bien compris les concepts clés de ce module ?',
                                competence: 'Maîtrise des concepts de base',
                                options: ['Oui, parfaitement', 'Oui, dans l\'ensemble', 'Partiellement', 'Non'],
                                correct: 0
                            }
                        ]
                    }
                }
            ];
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-text').textContent = message;
            
            console.error('Erreur formation:', message);
        }

        // Sauvegarde automatique et gestion de fermeture
        window.addEventListener('beforeunload', function(e) {
            if (!formationState.isPreview && !formationState.isTestMode && formationState.apprenantId) {
                saveProgress();
                logInteraction('session_end', 'Fermeture de session');
            }
        });

        setInterval(() => {
            if (!formationState.isPreview && !formationState.isTestMode && formationState.apprenantId) {
                saveProgress();
            }
        }, 30000);

        // Outils de debug
        window.smartAcademyQualiopi = {
            getState: () => formationState,
            getInteractions: () => formationState.progress.interactions,
            completeAllModules: () => {
                const formation = formationState.formation;
                for (let i = 0; i < formation.modules.length; i++) {
                    forceCompleteModule(i);
                    if (!formationState.progress.quizScores) {
                        formationState.progress.quizScores = {};
                    }
                    formationState.progress.quizScores[i] = 85;
                }
                updateDashboard();
                checkFormationCompletion();
                console.log('✅ Tous les modules complétés');
            }
        };

        console.log('🎓 Interface Formation Qualiopi Smart Academy - Version Complète Chargée !');
        console.log('💡 Utilisez le panel de test pour tester différentes configurations');
        console.log('🔧 Tapez smartAcademyQualiopi.getState() pour voir l\'état complet');
    </script>
</body>
</html>
